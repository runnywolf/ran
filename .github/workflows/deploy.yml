name: Deploy

on: # push main branch 會觸發部署
  workflow_dispatch: # 允許手動觸發
  push:
    branches: main
    paths-ignore:
      - "README.md" # 更改 readme 並不會觸發 deploy

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Make stat data # 生成 src/stat 內的 code-stat.json 和 problem-stat.json
        run: | # 先清掉 search cache, 因為不想要 search-data.json 被計入
          rm -f src/exam-db/search-data.json
          python src/stat/make-stat.py
      
      - name: Make search cache # 生成 src/exam-db/search-data.json (搜尋快取)
        run: python src/exam-db-tool/make-search-data.py
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Vite site (Ran app) # 建構 main app
        run: npm run build
      
      - name: Build VitePress docs # 建構 docs
        run: npm run docs:build
      
      - name: Move docs to ./dist/docs # 這樣 docs 路徑就會在 https://runnywolf.github.io/ran/docs/
        run: |
          mkdir -p dist/docs
          mv docs/.vitepress/dist/* dist/docs/
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./dist"
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

# [for windows shell] remove all workflow, run it in git folder
# gh run list --limit 1000 --json databaseId --jq ".[].databaseId" | ForEach-Object { gh run delete $_ }
